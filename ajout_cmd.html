<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gestion bijouterie</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <link href="css/sweetalert2.min.css">
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="css/style.css" rel="stylesheet" type="text/css">
    <script src="js/jquery-3.6.0.min.js" ></script>
    <script src="js/bootstrap.bundle.min.js" ></script>
    <script src="js/sweetalert2.all.min.js"></script>
    <script src="js/jquery.scannerdetection.js" ></script>
</head>
<body style="background: white;">
    
    <div class="mt-5">

<div class="col-md-4 float-left" style="position: relative;">
  <h3 class="title_page_2" >Ajouter <span>une vente</span></h3>
  <img  src="images/bijoux.jpg" style="max-width: 100%;height: 100%;">
</div>
<div  class="col-md-8 float-left">
    <!--<h1 class="title_page">Ajouter <span>une vente</span></h1>-->

  <div class=" col-md-4 float-left">
      <button style="background: #D9C059;border: #D9C059 !important;" class="btn btn-primary mt-4"  data-toggle='modal' data-target='#ModalAffichagePrd'>Affichage des produits</button>
  </div>

  <div class=" col-md-4 float-left">
    <button style="background: #D9C059;border: #D9C059 !important;" class="btn btn-primary mt-4"  data-toggle='modal' data-target='#ModalProduitLot'>Ajout produit par lot</button>
  </div>

  

    <form>
    <div class="form-group col-md-12 float-left mt-4">
      <label style="color:#D9C059;font-weight: bold;">Type client</label><br>
      <div class="form-check form-check-inline">
        <input class="form-check-input type_client" name="type_client" type="radio" value="1" id="defaultCheck1">
        <label class="form-check-label" for="defaultCheck1">
          Client occasionel
        </label>
      </div>

      <div class="form-check form-check-inline">
        <input class="form-check-input type_client" name="type_client" type="radio" value="2" checked id="defaultCheck2">
        <label class="form-check-label" for="defaultCheck2">
          Client régulier
        </label>
      </div>
  </div>


 


    <div class="form-group col-md-4 float-left" id="div_client_regulier">
        <label >Client</label>
        <div id="liste_client"></div>
    </div>




    <div class="form-group col-md-4 float-left" id="div_client_occasionel" style="display:none;">
      <label >Nom prénom</label>
        <input type="text" value="Client au comptoir" name="nom_client_occasionel" id="nom_client_occasionel" class="form-control">
    </div>
  
    <div class="form-group col-md-4 float-left" >
      <label >Date</label>
        <input type="text" name="date" id="date" class="form-control">
    </div>

   

   



    <table class="table table-bordered">
      <thead>
        <tr>
          <th scope="col">Référence</th>
          <th scope="col">Désignation</th>
          <th scope="col">Quantité</th>
          <th scope="col">Tarif de vente</th>
          <th scope="col">Tarif d'achat</th>
          <!--<th scope="col">Prix</th>-->
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody class="tbody_prd">
          
      </tbody>
     <!-- <tfoot>
        <tr>
          <td colspan="5" style="border-bottom: 1px solid #ffffff;border-left: 1px solid #ffffff;"></td>
          <td > Total : <span class="total">0</span></td> 
        </tr>
      </tfoot> --> 
    </table>



  <fieldset style="border: double;padding: revert;">
    <legend style="width: auto;color:#D9C059;font-weight: bold;">Mode de paiement : </legend>
    <div class="form-group col-md-12 float-left">
      <div class="form-check form-check-inline">
        <input class="form-check-input " name="mode_paiement" type="radio" checked value="1" id="defaultCheck3">
        <label class="form-check-label" for="defaultCheck3">
          Par carte bancaire
        </label>
      </div>

      <div class="form-check form-check-inline">
        <input class="form-check-input " name="mode_paiement" type="radio" value="2"  id="defaultCheck4">
        <label class="form-check-label" for="defaultCheck4">
          Par chéque
        </label>
      </div>

      <div class="form-check form-check-inline">
        <input class="form-check-input " name="mode_paiement" type="radio" value="3"  id="defaultCheck5">
        <label class="form-check-label" for="defaultCheck5">
          Par virement
        </label>
      </div>
    </div>
  </fieldset>



  <fieldset class="mt-4" style="border: double;padding: revert;">
    <legend style="width: auto;color:#D9C059;font-weight: bold;">Paiement : </legend>
    <a class="btn btn-primary float-right ajouter_montant" style="background: #D9C059;border: 1px solid #D9C059;">Ajouter</a>
    <div class="form-group col-md-12 float-left">
  
      <div class="div_paiement">
      <div class="form-group col-md-6 float-left">
        <label >Montant</label>
        <input type="text"  name="montant"  class="form-control">
      </div>
      <div class="form-group col-md-6 float-left">
        <label >Date</label>
        <input type="date"  name="date_montant"  class="form-control">
      </div>
      </div>

    </div>
  </fieldset>


    <div class="form-group col-md-4 float-left" id="div_montant_a_compte" style="display:none;">
      <label >Montant</label>
        <input type="text" name="montant_a_compte" id="montant_a_compte" class="form-control">
    </div>
  </form>


  <div class="col-md-12 float-left">
    <button style="background: black;
    border: black;"   class="btn btn-primary submit_form mt-4 mb-4">Confirmer</button>
</div>
</div>
    </div>

    

    <div class="modal fade" id="ModalAffichagePrd" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Affichage des produits</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
  
            <table class="table table-bordered">
              <thead>
                <tr>
                  <!--<th scope="col">Référence</th>-->
                  <th scope="col">Désignation</th>
                  <th scope="col">Tarif d'achat	</th>
             
                </tr>
              </thead>
              <tbody id="affichage_produit">
                  
              </tbody>
           
            </table>
              
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL ajout produit lot-->
    <div class="modal fade" id="ModalProduitLot" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Ajout produit de lot</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
             
            <div class="form-group col-md-4 float-left">
              <label >Catégorie</label>
              <div id="select_catig"></div>
            </div>

            <div class="form-group col-md-4 float-left">
              <label >Date</label>
              <input type="date" name="date_produit_lot" id="date_produit_lot" class="form-control" >
              </div>

            <div class="form-group col-md-4 float-left">
              <label >Désignation</label>
              <input type="text" name="name_product_lot" id="name_product_lot" class="form-control" >
            </div>
          
      
          
              <div class="form-group col-md-4 float-left">
              <label >Poids (g)</label>
              <input type="text" name="poids_lot" id="poids_lot" class="form-control" >
              </div>
          
              <div class="form-group col-md-4 float-left">
              <label >Prix d'achat (DH)</label>
              <input type="text" name="prix_lot" id="prix_lot"  class="form-control" >
              </div>

              <div class="form-group col-md-4 float-left" id="div_poids_2" style="display: none;">
                <label >Poids (carrat)</label>
                <input type="text" name="poids_2_lot" id="poids_2_lot" class="form-control" >
              </div>
          
              <div class="form-group col-md-4 float-left" id="div_prix_2" style="display: none;">
                <label >Prix d'achat 2 (DH)</label>
                <input type="text" name="prix_2_lot" id="prix_2_lot"  class="form-control" >
              </div>

              <div class="form-group col-md-4 float-left">
                <label >Fournisseur</label>
                <input type="text" name="fournisseur_lot" id="fournisseur_lot" class="form-control" >
              </div>
         
              
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
            <button type="button" class="btn btn-primary" id="save_product_lot" >Enregistrer</button>
          </div>
        </div>
      </div>
    </div>
    <!-- MODAL ajout produit lot-->

    <script>
        $(document).ready(function(){

function sweetAlert(textA,iconA){
Swal.fire({
title: '',
text: textA,
icon: iconA,
confirmButtonText: 'Ok'
 });
}


$(document).on("change","#catig",function(){
     
     var catigA= $(this).val();
 
     if(catigA==16){
       $("#div_poids_2").show();
       $("#div_prix_2").show();
     }else{
       $("#div_poids_2").hide();
       $("#div_prix_2").hide();
       $("#poids_2_lot").val("");
       $("#prix_2_lot").val("");
     }
 
    })

     //START GET LISTE CATIG SELECT
  $.ajax({
       url : 'https://www.proweb.ma/bijoux/module_catig.php',
       type : 'POST',
       dataType : 'html', 
       data : 'select_catig=true',
       success : function(data){ 
           $('#select_catig').html(data);
       }
     });   
  //END   GET LISTE CATIG SELECT

   //START AJOUT PAIEMENT
    $(document).on("click",".ajouter_montant",function(){
       console.log("ee");
      var html_paiement='<div class="div_paiement">\
      <div class="form-group col-md-6 float-left">\
        <label >Montant</label>\
        <input type="text"  name="montant"  class="form-control">\
      </div>\
      <div class="form-group col-md-6 float-left">\
        <label >Date</label>\
        <input type="date"  name="date_montant"  class="form-control">\
      </div>\
      </div>';

      $('.div_paiement:last').after(html_paiement);
    });

   //END AJOUT PAIEMENT


  var today = new Date();
  var dd = String(today.getDate()).padStart(2, '0');
  var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
  var yyyy = today.getFullYear();

  date_today = dd + '/' +  mm + '/' + yyyy;
  $("#date").val(date_today);

     //START GET LISTE client 
       $.ajax({
       url : 'https://www.proweb.ma/bijoux/module_cmd.php',
       type : 'POST',
       dataType : 'html', 
       data : 'liste_client=true',
       success : function(data){ 
           $('#liste_client').html(data);
       }
     });
      //END GET LISTE client

      //START GET LISTE produit 
      $.ajax({
       url : 'https://www.proweb.ma/bijoux/module_cmd.php',
       type : 'POST',
       dataType : 'html', 
       data : 'liste_produit=true',
       success : function(data){ 
           $('#liste_produit').html(data);
       }
      });
      //END GET LISTE produit


      //START GET AFFICHAGE PRODUCT 
      $.ajax({
       url : 'https://www.proweb.ma/bijoux/module_produits.php',
       type : 'POST',
       dataType : 'html', 
       data : 'affichage_produit=true',
       success : function(data){ 
           $('#affichage_produit').html(data);
       }
      });
      //END GET AFFICHAGE PRODUCT 

      
   $(document).on("click","#submit_cmd",function(){
     var client= $("#client").val();
     var produit= $("#produit").val();

     if(client=="") sweetAlert("Client est obligatoire",'error')
     else if(produit=="") sweetAlert("Produit est obligatoire",'error');
     else{
    $.ajax({
       url : 'https://www.proweb.ma/bijoux/module_cmd.php',
       type : 'POST',
       dataType : 'html', 
       data : 'insert_cmd=true&client='+client+"&produit="+produit,
       success : function(data){ 
       if(data==1) sweetAlert("Votre enregistrement a été ajouté avec succès.",'success');
       }
    });
  }
    });


        //START CHANGE TYPE CLIENT
        $(document).on("change",".type_client",function(){
           var type_client=$(this).val();
           if(type_client==1){
            $("#div_client_regulier").hide();
            $("#div_client_occasionel").show();
           }else if (type_client==2){
            $("#div_client_occasionel").hide();
            $("#div_client_regulier").show();
           }
        });
        //END CHANGE TYPE CLIENT


         //START CHANGE TYPE VENTE
          $(document).on("change",".select_type_vente",function(){
           var select_type_vente=$(this).val();
           var id_product=$(this).attr("id_product");
           var reduction = $(this).find('option:selected').attr('reduction');
           var tarif_public=$('.tarif_public_'+id_product).text();
           var qte=$('.qte_prd_'+id_product).val();

           var as1=parseFloat(tarif_public*qte);
           var total = as1 - (parseFloat(as1*reduction/100));
           $(".tarif_product"+id_product).text(total);
           $(".total").text(SumTarif());       
        });
        //END CHANGE TYPE VENTE

        //START CHANGE a compte 
           $(document).on("change",".a_compte",function(){
           var a_compte=$(this).val();
           if(a_compte==1){
            $("#div_montant_a_compte").show();
           }else if (a_compte==2){
            $("#div_montant_a_compte").hide();
           }
          });
        //END CHANGE a compte


        //START CHOOSE PRODUCT
        $(document).on("click",".select_produit",function(){
           var reference_product=$(this).attr("reference_product");
           var id_product=$(this).attr("id_product");
           var prix_product=$(this).attr("prix_product");
           var nom_product=$(this).attr("nom_product");
 

           var html='<tr class="tr_module tr_prd_'+id_product+'">\
            <td>'+reference_product+'</td>\
            <td><input type="hidden" name="produit" value="'+id_product+'">'+nom_product+'</td>\
            <td><input type="number" name="qte" prix_product="'+prix_product+'" id_product="'+id_product+'"  value="1" class="form-control qte_prd_'+id_product+' qte_prd "></td>\
            <!--<td>'+GetTypeVente(id_product)+'</td>-->\
            <td><input type="number" class="form-control" name="prix_vente" ></td>\
            <td class="tarif_public_'+id_product+'">'+prix_product+'</td>\
            <!--<td class="tarif_product tarif_product'+id_product+'">'+prix_product+'</td>-->\
            <td><i id_product="'+id_product+'" class="fa fa-2x fa-trash-o remove_product"></i></td>\
            </tr>';

            if ($(".tr_module")[0]){
               $(".tr_module:last").after(html); 
                } else {
               $(".tbody_prd").html(html);
               }

            $("#ModalAffichagePrd").modal("hide"); 
            $(this).hide();
            $(".total").text(SumTarif());

        });
        //END   CHOOSE PRODUCT


        //START REMOVE PRODUCT IN LISTE
        $(document).on("click",".remove_product",function(){
          var id_product= $(this).attr('id_product');

          $(".tr_prd_"+id_product).remove();
          $(".select_produit_"+id_product).show();
          $(".total").text(SumTarif());
        });
        //END REMOVE PRODUCT IN LISTE

        //START KEYUP QUANTITE
         $(document).on("change paste keyup input",'.qte_prd',function(){
          var id_product= $(this).attr('id_product');
          var prix_product= $(this).attr('prix_product');
          var reduction = $(".select_type_vente_"+id_product).find('option:selected').attr('reduction');
          var tarif_public=$('.tarif_public_'+id_product).text();
          var qte= $(this).val();
          var as1=parseFloat(tarif_public*qte);
          var total = as1 - (parseFloat(as1*reduction/100));
          //var total=parseFloat(qte*prix_product).toFixed(2);

          $('.tarif_product'+id_product).html(total);
          $(".total").text(SumTarif());

         });

        //end   KEYUP QUANTITE

      //START CALCUL TOTAL TARIF
        function SumTarif() {
        var sum = 0;
          $(".tarif_product").each(function() {   
            sum += +$(this).text()||0;
       });
       return sum.toFixed(2); 
       }
       //END CALCUL TOTAL TARIF

       //START GET TYPE DE VENTE
        function GetTypeVente(id_product){
          var result ="";
          $.ajax({
           url : 'https://www.proweb.ma/bijoux/module_type_vente.php',
           type : 'POST',
           dataType : 'html', 
           async: false, 
           data : 'select_type_vente=true&id_product='+id_product,
           success : function(data){ 
          
           result = data;
          }
        });
        return result;
        }
       //END  GET TYPE DE VENTE


       //Start save product lot
       $(document).on("click","#save_product_lot",function(){

       var name_product_lot= $("#name_product_lot").val();
       var poids_lot= $("#poids_lot").val();
       var catig= $("#catig").val();
       var prix_lot= $("#prix_lot").val();
       var date_produit_lot= $("#date_produit_lot").val();
       var fournisseur_lot= $("#fournisseur_lot").val();
       var poids_2_lot= $("#poids_2_lot").val();
       var prix_2_lot= $("#prix_2_lot").val();
      
       

       if(name_product_lot=="") sweetAlert("Désignation est obligatoire",'error')
       else if(poids_lot=="") sweetAlert("Poids est obligatoire",'error');
       else if(prix_lot=="") sweetAlert("Prix est obligatoire",'error');
       else if(date_produit_lot=="") sweetAlert("Date est obligatoire",'error');
       else{
         $.ajax({
           url : 'https://www.proweb.ma/bijoux/produit_lot.php',
           type : 'POST',
           dataType : 'html',   
           data : 'insert_produit_lot=true&name_product_lot='+name_product_lot+"&poids_lot="+poids_lot+"&prix_lot="+prix_lot+"&catig="+catig+"&date_produit_lot="+date_produit_lot+"&fournisseur_lot="+fournisseur_lot+"&poids_2_lot="+poids_2_lot+"&prix_2_lot="+prix_2_lot,
           success : function(data){ 
            if ($(".tr_module")[0]){
               $(".tr_module:last").after(data); 
                } else {
               $(".tbody_prd").html(data);
               }

               $("#ModalProduitLot").modal("hide"); 
               $("#name_product_lot").val("");
               $("#poids_lot").val("");
               $("#prix_lot").val("");
               $("#date_produit_lot").val("");
               $("#fournisseur_lot").val("");
               $("#poids_2_lot").val("");
               $("#prix_2_lot").val("");
            
         }
       });
   }
   });
//END save product lot

       //START DETECT SCANNER


       $(document).scannerDetection({
	timeBeforeScanTest: 200, // wait for the next character for upto 200ms
	avgTimeByChar: 100, // it's not a barcode if a character takes longer than 100ms
	onComplete: function(barcode, qty){
     
       $.ajax({
       url : 'https://www.proweb.ma/bijoux/module_produits.php',
       type : 'POST',
       dataType : 'html', 
       data : 'search_product='+barcode,
       success : function(data){ 
        data = $.parseJSON(data);
     

        var html='<tr class="tr_module tr_prd_'+data.id_product+'">\
            <td>'+data.reference_product+'</td>\
            <td><input type="hidden" name="produit" value="'+data.id_product+'">'+data.nom_product+'</td>\
            <td><input  type="number" name="qte" prix_product="'+data.prix_product+'" id_product="'+data.id_product+'"  value="1" class="form-control qte_prd_'+data.id_product+' qte_prd "></td>\
            <!--<td>'+GetTypeVente(data.id_product)+'</td>-->\
            <td><input type="number" class="form-control" name="prix_vente" ></td>\
            <td class="tarif_public_'+data.id_product+'">'+data.prix_product+'</td>\
            <!--<td class="tarif_product tarif_product'+data.id_product+'">'+data.prix_product+'</td>-->\
            <td><i id_product="'+data.id_product+'" class="fa fa-2x fa-trash-o remove_product"></i></td>\
            </tr>';

            if ($(".tr_module")[0]){
               $(".tr_module:last").after(html); 
                } else {
               $(".tbody_prd").html(html);
               }

            $(".select_produit_"+data.id_product).hide();   
            $("#ModalAffichagePrd").modal("hide"); 
            $(this).hide();
            $(".total").text(SumTarif());
        
     
       }
     });
    } // main callback function	
});




       //END   DETECT SCANNER


       //START SEND FORM

       $.fn.serializeObject = function () {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function () {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };


       $(document).on("click",".submit_form",function(){
        var serializObjct = $("form").serializeObject();
        console.log(serializObjct);
        $.ajax({
           url : 'https://www.proweb.ma/bijoux/save_cmd.php',
           type : 'POST',
           dataType : 'html', 
           data : { data : serializObjct},
           success : function(data){ 
            console.log(data);
            window.location.href="detail_cmd.html?id="+data;
          }
        });
       });

       //END SEND FORM
    

       

        });
        
    </script>



<style>
  .remove_product,.select_produit{
    cursor: pointer;
  }
  .fa-trash-o{
    color : red;
  }
</style>
    </body>

    </html>
